<div class="admin-products">
  <div class="products-header">
    <h2>Products Management</h2>
    <app-button (click)="openCreateForm()" shape="rounded">Add New Product</app-button>
  </div>

  <div class="filters-section">
    <app-search
      placeholder="Search products..."
      (search)="onSearchChange($event)"
      class="search-input"
    />
    <app-dropdown
      [options]="categoryDropdownOptions()"
      [selectedValue]="filters.categoryId() || ''"
      placeholder="All Categories"
      (selectionChange)="onCategoryChange($event)"
    />
    @if (filters.hasActiveFilters()) {
      <app-button (click)="clearFilters()" variant="secondary" shape="rounded">
        Clear Filters
      </app-button>
    }
  </div>

  @if (showForm()) {
    <app-modal-form
      [title]="editingProduct() ? 'Edit Product' : 'Create New Product'"
      (close)="closeForm()"
    >
      <form [formGroup]="productForm" (ngSubmit)="saveProduct()">
        @if (formError()) {
          <div class="form-error-banner">{{ formError() }}</div>
        }

        <app-form-field
          [control]="$any(productForm.get('name'))"
          [id]="'name'"
          [label]="'Product Name'"
          [fullWidth]="true"
          [errorMessage]="'Product name is required (min 3 characters)'"
        />

        <div class="slug-field-wrapper">
          <app-form-field
            [control]="$any(productForm.get('slug'))"
            [id]="'slug'"
            [label]="'Slug'"
            [fullWidth]="true"
            [errorMessage]="'Slug is required (letters, numbers, hyphens)'"
          />
          <app-button
            type="button"
            (click)="manuallyGenerateSlug()"
            variant="secondary"
            shape="rounded"
            class="slug-generate-btn"
            title="Generate slug from name"
          >
            Generate
          </app-button>
        </div>

        <app-form-field
          [control]="$any(productForm.get('description'))"
          [id]="'description'"
          [label]="'Description'"
          [type]="'textarea'"
          [fullWidth]="true"
          [errorMessage]="'Description is required'"
        />

        <div class="form-row">
          <app-form-field
            [control]="$any(productForm.get('price'))"
            [id]="'price'"
            [label]="'Price'"
            [type]="'number'"
            [errorMessage]="'Price is required'"
          />

          <app-form-field
            [control]="$any(productForm.get('currency'))"
            [id]="'currency'"
            [label]="'Currency'"
            [type]="'select'"
            [errorMessage]="'Currency is required'"
          >
            <option value="USD">USD</option>
            <option value="EUR">EUR</option>
            <option value="GBP">GBP</option>
          </app-form-field>

          <app-form-field
            [control]="$any(productForm.get('stock'))"
            [id]="'stock'"
            [label]="'Stock'"
            [type]="'number'"
            [errorMessage]="'Stock is required'"
          />
        </div>

        <app-form-field
          [control]="$any(productForm.get('categoryId'))"
          [id]="'categoryId'"
          [label]="'Category'"
          [type]="'select'"
          [fullWidth]="true"
          [errorMessage]="'Category is required'"
        >
          <option value="">Select a category</option>
          @for (category of categories(); track category.id) {
            <option [value]="category.id">{{ category.name }}</option>
          }
        </app-form-field>

        <app-form-field
          [control]="$any(productForm.get('sellerId'))"
          [id]="'sellerId'"
          [label]="'Seller ID'"
          [fullWidth]="true"
          [errorMessage]="'Seller ID is required'"
        />

        <app-image-gallery-manager
          [images]="productImages()"
          (imagesChange)="onProductImagesChange($event)"
        />

        <app-form-checkbox
          [control]="$any(productForm.get('featured'))"
          [id]="'featured'"
          [label]="'Mark as Featured'"
          [subtitle]="'Featured products will be highlighted on the homepage'"
        />

        <div class="form-actions">
          <app-button type="button" (click)="closeForm()" variant="secondary" shape="rounded"
            >Cancel</app-button
          >
          <app-button type="submit" [disabled]="productForm.invalid || loading()" shape="rounded">
            {{ editingProduct() ? 'Update' : 'Create' }} Product
          </app-button>
        </div>
      </form>
    </app-modal-form>
  }

  @if (loading() && products().length === 0) {
    <app-loading-indicator message="Loading products..." />
  }

  @if (!loading() && products().length === 0) {
    <p class="no-products">No products found. Create your first product!</p>
  }

  @if (products().length > 0) {
    <div class="products-list">
      @for (product of products(); track product.id) {
        <app-admin-item-card
          [imageUrl]="product.imageUrls.length > 0 ? product.imageUrls[0] : ''"
          [imageAlt]="product.name"
          [title]="product.name"
          [description]="product.description"
          [badges]="product.featured ? [{ label: '⭐ Featured', variant: 'featured' }] : []"
          [metadata]="[
            { label: 'Price', value: product.price + ' ' + product.currency },
            { label: 'Stock', value: (product.stock ?? 0).toString() },
            { label: 'Seller', value: product.seller.displayName },
          ]"
          (edit)="openEditForm(product)"
          (delete)="deleteProduct(product)"
        />
      }
    </div>

    @if (hasMore() && !loadingMore()) {
      <div
        class="scroll-sentinel"
        appIntersectionObserver
        (intersecting)="onLoadMore()"
        aria-hidden="true"
      >
        <!-- Sentinel is only in DOM when ready to load -->
      </div>
    }

    @if (loadingMore()) {
      <app-loading-indicator message="Loading more products..." />
    }

    @if (!hasMore() && !loadingMore()) {
      <div class="end-message">
        <p>You've reached the end of the product list</p>
      </div>
    }
  }
</div>
