<div class="admin-products">
  <div class="products-header">
    <h2>Products Management</h2>
    <app-button (click)="openCreateForm()" shape="rounded">Add New Product</app-button>
  </div>

  <div class="filters-section">
    <app-search
      placeholder="Search products..."
      (searchSubmitted)="onSearchChange($event)"
      class="search-input"
    />
    <app-dropdown
      [options]="categoryDropdownOptions()"
      [selectedValue]="filters.categoryId() || ''"
      placeholder="All Categories"
      (selectionChange)="onCategoryChange($event)"
    />
    @if (filters.hasActiveFilters()) {
      <app-button (click)="clearFilters()" variant="secondary" shape="rounded">
        Clear Filters
      </app-button>
    }
  </div>

  @if (showForm()) {
    <app-modal-form
      [title]="editingProduct() ? 'Edit Product' : 'Create New Product'"
      (close)="closeForm()"
    >
      <app-admin-product-form
        [editingProduct]="editingProduct()"
        [categories]="categories()"
        [loading]="loading()"
        [formError]="formError()"
        (save)="saveProduct($event)"
        (cancel)="closeForm()"
      />
    </app-modal-form>
  }

  @if (loading() && products().length === 0) {
    <app-loading-indicator message="Loading products..." />
  }

  @if (!loading() && products().length === 0) {
    <app-empty-state
      icon="package"
      heading="No products found"
      description="Create your first product to get started."
      ctaLabel="Add Product"
      [ctaAction]="openCreateForm.bind(this)"
    />
  }

  @if (products().length > 0) {
    <div class="products-list">
      @for (product of products(); track product.id) {
        <app-admin-item-card
          [imageUrl]="product.imageUrls.length > 0 ? product.imageUrls[0] : ''"
          [imageAlt]="product.name"
          [title]="product.name"
          [description]="product.description"
          [badges]="product.featured ? [{ label: 'â­ Featured', variant: 'featured' }] : []"
          [metadata]="[
            { label: 'Price', value: product.price + ' ' + product.currency },
            { label: 'Stock', value: (product.stock ?? 0).toString() },
            { label: 'Seller', value: product.seller.displayName },
          ]"
          (edit)="openEditForm(product)"
          (delete)="deleteProduct(product)"
        />
      }
    </div>

    @if (hasMore() && !loadingMore()) {
      <div
        class="scroll-sentinel"
        appIntersectionObserver
        (intersecting)="onLoadMore()"
        aria-hidden="true"
      >
        <!-- Sentinel is only in DOM when ready to load -->
      </div>
    }

    @if (loadingMore()) {
      <app-loading-indicator message="Loading more products..." />
    }

    @if (!hasMore() && !loadingMore()) {
      <div class="end-message">
        <p>You've reached the end of the product list</p>
      </div>
    }
  }
</div>
