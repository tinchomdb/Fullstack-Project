<div class="admin-categories">
  <div class="categories-header">
    <h2>Categories Management</h2>
    <app-button (click)="openCreateForm()" shape="rounded">Add New Category</app-button>
  </div>

  @if (showForm()) {
    <app-modal-form
      [title]="editingCategory() ? 'Edit Category' : 'Create New Category'"
      [maxWidth]="'500px'"
      (close)="closeForm()"
    >
      <form [formGroup]="categoryForm" (ngSubmit)="saveCategory()">
        <app-form-field
          [control]="$any(categoryForm.get('name'))"
          [id]="'name'"
          [label]="'Category Name'"
          [fullWidth]="true"
          [errorMessage]="'Category name is required (min 2 characters)'"
        />

        <div class="slug-field-wrapper">
          <app-form-field
            [control]="$any(categoryForm.get('slug'))"
            [id]="'slug'"
            [label]="'Slug'"
            [fullWidth]="true"
            [errorMessage]="'Slug is required (lowercase letters, numbers, and hyphens only)'"
          />
          <app-button
            type="button"
            (click)="manuallyGenerateSlug()"
            variant="secondary"
            shape="rounded"
            class="slug-generate-btn"
            title="Generate slug from name"
          >
            Generate
          </app-button>
        </div>

        <app-form-field
          [control]="$any(categoryForm.get('description'))"
          [id]="'description'"
          [label]="'Description'"
          [type]="'textarea'"
          [fullWidth]="true"
          [errorMessage]="''"
        />

        <app-form-field
          [control]="$any(categoryForm.get('image'))"
          [id]="'image'"
          [label]="'Image URL'"
          [fullWidth]="true"
          [errorMessage]="''"
        />

        <app-form-checkbox
          [control]="$any(categoryForm.get('featured'))"
          [id]="'featured'"
          [label]="'Mark as Featured'"
          [subtitle]="'Featured categories will be highlighted on the homepage'"
        />

        <app-form-field
          [control]="$any(categoryForm.get('parentCategoryId'))"
          [id]="'parentCategoryId'"
          [label]="'Parent Category'"
          [type]="'select'"
          [fullWidth]="true"
          [errorMessage]="''"
        >
          <option value="">None (Top-level category)</option>
          @for (category of getAvailableParentCategories(); track category.id) {
            <option [value]="category.id">{{ category.name }}</option>
          }
        </app-form-field>

        <div class="form-actions">
          <app-button type="button" (click)="closeForm()" variant="secondary" shape="rounded"
            >Cancel</app-button
          >
          <app-button type="submit" [disabled]="categoryForm.invalid || loading()" shape="rounded">
            {{ editingCategory() ? 'Update' : 'Create' }} Category
          </app-button>
        </div>
      </form>
    </app-modal-form>
  }

  <div class="categories-tree">
    @if (categories().length === 0 && !loading()) {
      <p class="no-categories">No categories found. Create your first category!</p>
    }

    @for (node of categoryTree(); track node.category.id) {
      <app-admin-category-tree-item
        [node]="node"
        (edit)="openEditForm($event)"
        (delete)="deleteCategory($event)"
      />
    }
  </div>
</div>
